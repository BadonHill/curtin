showtrace: true

early_commands:
  # running block-meta custom from the install environment
  # inherits the CONFIG environment, so this works to actually prepare
  # the disks exactly as in this config before the rest of the install
  # will just blow it all away.  We have clean out other environment
  # that could unintentionally mess things up.
  blockmeta: [env, -u, OUTPUT_FSTAB,
              TARGET_MOUNT_POINT=/tmp/my.bdir/target,
              WORKING_DIR=/tmp/my.bdir/work.d, 
              curtin, --showtrace, -v, block-meta, --umount, custom]

storage:
  config:
  - id: id_rotary0
    type: disk
    name: rotary0
    path: /dev/vdb
    ptable: msdos
    wipe: superblock
    grub_device: true
  - id: id_ssd0
    type: disk
    name: ssd0
    path: /dev/vdc
    wipe: superblock
  - id: id_rotary0_part1
    type: partition
    name: rotary0-part1
    device: id_rotary0
    number: 1
    offset: 1M
    size: 999M
    wipe: superblock
  - id: id_rotary0_part2
    type: partition
    name: rotary0-part2
    device: id_rotary0
    number: 2
    size: 9G
    wipe: superblock
  - id: id_bcache0
    type: bcache
    name: bcache0
    backing_device: id_rotary0_part2
    cache_device: id_ssd0
    cache_mode: writeback
  - id: bootfs
    type: format
    label: boot-fs
    volume: id_rotary0_part1
    fstype: ext4
  - id: rootfs
    type: format
    label: root-fs
    volume: id_bcache0
    fstype: ext4
  - id: rootfs_mount
    type: mount
    path: /
    device: rootfs
  - id: bootfs_mount
    type: mount
    path: /boot
    device: bootfs
  version: 1
