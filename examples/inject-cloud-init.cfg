system_upgrade:
    enabled: true
apt:
    preserve_sources_list: false
    sources:
        cloud-init-test-repo.list:
            source: "deb http://ppa.launchpad.net/raharper/cloud-init-dev/ubuntu $RELEASE main"
            keyid: C660A937

write_files:
  systemd_networkd_wait_online_path:
    path: /lib/systemd/system/systemd-networkd-wait-online.path
    content: 
     |
     [Unit]
     Description=Trigger systemd-networkd-wait-online if netplan updates
     
     [Path]
     PathChanged=/run/systemd/generator/netplan.stamp

late_commands:
  00_ci_ver: ['sh', '-xc', 'curtin in-target -- apt-cache policy cloud-init']
  01_ci_down:  ['curtin', 'in-target', '--', 'sh', '-c', 'R=`lsb_release -sc`; if [ "$R" = "yakkety" -o "$R" = "zesty" ]; then apt-get install --yes --allow-downgrades cloud-init=0.7.9-99-g1c1fc3a-1~bddeb; fi; exit 0;']
  01_ci_netp:  ['curtin', 'in-target', '--', 'sh', '-c', 'R=`lsb_release -sc`; if [ "$R" = "yakkety" -o "$R" = "zesty" ]; then /bin/echo -e "system_info:\n network:\n  renderers:\n      - netplan\n" > /etc/cloud/cloud.cfg.d/vmtest-network.cfg; fi; exit 0;']
  01_nplan:    ['curtin', 'in-target', '--', 'sh', '-c', 'R=`lsb_release -sc`; if [ "$R" = "yakkety" -o "$R" = "zesty" ]; then apt-get install --yes nplan; fi; exit 0']
  01_systemd:  ['curtin', 'in-target', '--', 'sh', '-c', 'R=`lsb_release -sc`; if [ "$R" = "yakkety" -o "$R" = "zesty" ]; then apt-get install --yes systemd; fi; exit 0']
  01_networkd: ['curtin', 'in-target', '--', 'sh', '-c', 'R=`lsb_release -sc`; if [ "$R" = "yakkety" -o "$R" = "zesty" ]; then ln -sf /lib/systemd/system/systemd-networkd.service /etc/systemd/system/network-online.target.wants/systemd-networkd.service; fi; exit 0;']
