#!/bin/sh
PY3OR2_MCHECK="curtin.checkdeps"
PY3OR2_MAIN="curtin.commands.main"
PY3OR2_PYTHONS=${PY3OR2_PYTHONS:-"python3:python2:python"}
PYTHON=${PY3OR2_PYTHON}

debug() {
   [ "${PY3OR2_DEBUG:-0}" != "0" ] || return 0
   echo "$@" 1>&2
}

mydir=${0%/*}
updir=${mydir%/*}
if [ "${mydir#${updir}/}" = "bin" -a -d "$updir/${PY3OR2_MCHECK%%.*}" ]; then
    updir=$(cd "$mydir/.." && pwd)
    case "$PYTHONPATH" in
        *:$updir:*|$updir:*|*:$updir) :;;
        *) export PYTHONPATH="$updir${PYTHONPATH:+:$PYTHONPATH}"
           debug "adding '$updir' to PYTHONPATH"
            ;;
    esac
fi

if [ ! -n "$PYTHON" ]; then
    err=""
    oifs="$IFS"; IFS=":"
    for p in $PY3OR2_PYTHONS; do
        command -v "$p" >/dev/null 2>&1 ||
            { debug "$p: not in path"; continue; }
        out=$($p -m "$PY3OR2_MCHECK" 2>&1) && PYTHON="$p" && break
        debug "$p: $out"
    done
    IFS="$oifs"
    [ -n "$PYTHON" ] || {
       echo "no availble python? [PY3OR2_DEBUG=1 for more info]" 1>&2;
       exit 1;
    }
fi
debug "executing: $PYTHON -m \"$PY3OR2_MAIN\" $*"
echo exec $PYTHON -m "$PY3OR2_MAIN" "$@"
